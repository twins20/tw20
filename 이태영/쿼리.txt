-- cMemProjApplyWrite 사업자 프로젝트 등록

--"You cannot specify a sequence in any part of a multitable insert statement. A multitable insert is considered a single SQL statement. Therefore, the first reference to NEXTVAL generates the next number, and all subsequent references in the statement return the same number."
--"다중 테이블 삽입 문에서 시퀀스를 지정할 수 없습니다. 다중 테이블 삽입은 단일 SQL 문으로 간주됩니다. 따라서 NEXTVAL에 대한 첫 번째 참조는 다음 번호를 생성하며 명령문의 모든 후속 참조는 동일한 번호를 반환합니다."

CREATE OR REPLACE FUNCTION GET_SEQ_TF_ITIDX RETURN NUMBER AS NUM NUMBER;
BEGIN
  SELECT SEQ_TF_ITIDX.NEXTVAL
  INTO NUM
  FROM DUAL;
  RETURN NUM;
END GET_SEQ_TF_ITIDX;

INSERT ALL
  INTO TF_PROJECT_LIST (PIDX, IDX, PNAME, PCATE, CONTENTS, ITLIST1, ITLIST2, ITLIST3, ITLIST4, ITLIST5, ITLISTCNT, PTFUNDS, PNFUNDS, PGRADE, STATUS, INSDATE, PSDATE, PEDATE, PCDATE, CHKADMIN) 
    VALUES (SEQ_TF_PIDX.NEXTVAL, 5, '테스트 프로젝트 입력 권석', 'TECH', '테스트 프로젝트 입력 권석 내용', (SELECT GET_SEQ_TF_ITIDX() FROM DUAL), (SELECT GET_SEQ_TF_ITIDX() FROM DUAL), (SELECT GET_SEQ_TF_ITIDX() FROM DUAL), (SELECT GET_SEQ_TF_ITIDX() FROM DUAL), (SELECT GET_SEQ_TF_ITIDX() FROM DUAL), 5, 1000000, 0, 5, 0, SYSDATE, SYSDATE, NULL, NULL, NULL)
  INTO TF_ITEM_LIST (ITIDX, PIDX, ITNAME, ITPRICE, CONTENTS, ITTCNT, ITSCNT, STATUS)
    VALUES (SEQ_TF_ITIDX.CURRVAL+1, SEQ_TF_PIDX.CURRVAL, '테스트 프로젝트 아이템1', 1000000, '테스트 프로젝트 아이템1 내용', 100, 0, 1)
  INTO TF_ITEM_LIST (ITIDX, PIDX, ITNAME, ITPRICE, CONTENTS, ITTCNT, ITSCNT, STATUS)
    VALUES (SEQ_TF_ITIDX.CURRVAL+2, SEQ_TF_PIDX.CURRVAL, '테스트 프로젝트 아이템2', 1000000, '테스트 프로젝트 아이템2 내용', 100, 0, 1)
  INTO TF_ITEM_LIST (ITIDX, PIDX, ITNAME, ITPRICE, CONTENTS, ITTCNT, ITSCNT, STATUS)
    VALUES (SEQ_TF_ITIDX.CURRVAL+3, SEQ_TF_PIDX.CURRVAL, '테스트 프로젝트 아이템3', 1000000, '테스트 프로젝트 아이템3 내용', 100, 0, 1)
  INTO TF_ITEM_LIST (ITIDX, PIDX, ITNAME, ITPRICE, CONTENTS, ITTCNT, ITSCNT, STATUS)
    VALUES (SEQ_TF_ITIDX.CURRVAL+4, SEQ_TF_PIDX.CURRVAL, '테스트 프로젝트 아이템4', 1000000, '테스트 프로젝트 아이템4 내용', 100, 0, 1)
  INTO TF_ITEM_LIST (ITIDX, PIDX, ITNAME, ITPRICE, CONTENTS, ITTCNT, ITSCNT, STATUS)
    VALUES (SEQ_TF_ITIDX.CURRVAL+5, SEQ_TF_PIDX.CURRVAL, '테스트 프로젝트 아이템5', 1000000, '테스트 프로젝트 아이템5 내용', 100, 0, 1)
SELECT * FROM DUAL;

--TF_PROJECT_LIST 테이블에 INSERT시 ITLIST1,ITLIST2,,, 칼럼에 SEQ_TF_ITIDX.NEXTVAL값을 입력할경우 다중테이블 삽입문이므로 처음 NEXTVAL값이 일괄적으로 적용됨.
--GET_SEQ_TF_ITIDX()값을 입력할경우 SEQ값이 증가하지만 최종적으로 적용되는 SEQ값이 일괄적으로 적용됨.
--따라서 DUAL 테이블의 더미 칼럼에 GET_SEQ_TF_ITIDX()값을 넣어서 SELECT하는 방식으로 해결.

--TF_ITEM_LIST 테이블에 INSERT시 각 ITIDX값은 SEQ_TF_ITIDX.NEXTVAL값을 사용할경우 시퀀스가 증가하므로 CURRVAL값이 다중테이블에 의해 초기값만 적용되는것을 이용 각 CURRVAL에 +1씩 증가시켜 입력


-- cMemProjApplyMod 사업자 프로젝트 수정





-- 아이템 리스트 추가 프로세스

-- 먼저 프로젝트에 등록되어있는 ITLISTCNT 값을 조회, ITLISTCNT 값이 4이하인경우 ITIDX 시퀀스 값을 선점
SELECT ITLISTCNT,SEQ_TF_ITIDX.NEXTVAL FROM TF_PROJECT_LIST WHERE ITLISTCNT < 5 AND PIDX = 1;
-- 해당시퀀스 값으로 TF_ITEM_LIST 테이블 ROW 추가(아래 SEQ_TF_ITIDX.CURRVAL 은 추후 변수값으로 변경요망 - 현재 테스트를 위해서 삽입)
INSERT INTO TF_ITEM_LIST (ITIDX, PIDX, ITNAME, ITPRICE, CONTENTS, ITTCNT, ITSCNT, STATUS)
  VALUES (SEQ_TF_ITIDX.CURRVAL, 1, '', '', '', 100, 0, 1);
-- 프로젝트 리스트의 ITLIST1,2,3,4,5 칼럼에 추가된 ITIDX를 입력, ITLISTCNT값 수정
UPDATE TF_PROJECT_LIST SET ITLISTCNT = ITLISTCNT + 1, ITLIST5 = SET_TF_ITIDX.CURRVAL WHERE PIDX = 1;





-- cMemProjNowList 사업자 현재 진행중 프로젝트

-- 실제 적용쿼리 SELECT * FROM TF_PROJECT_LIST WHERE STATUS = 1 AND IDX = ?;
SELECT * FROM TF_PROJECT_LIST WHERE STATUS = 1 AND IDX = 2;


-- cMemProjNowInfoGraph 사업자 현재 진행중 프로젝트 투자 인포 그래프

-- 실제 적용쿼리 SELECT A.*, B.PTFUNDS, ROWNUM FROM TF_FUND_HIS A, TF_PROJECT_LIST B WHERE A.PIDX = B.PIDX AND (B.IDX = ? AND B.STATUS = 1 AND A.STATUS = 0) ORDER BY FIDX ASC;
SELECT A.*, B.PTFUNDS, ROWNUM FROM TF_FUND_HIS A, TF_PROJECT_LIST B WHERE A.PIDX = B.PIDX AND (B.IDX = 2 AND B.STATUS = 1 AND A.STATUS = 0) ORDER BY FIDX ASC;


--cMemProjNowFundList  사업자 현재 진행중 프로젝트 투자 회원 리스트

-- 실제 적용 쿼리 SELECT B.*, C.* FROM TF_PROJECT_LIST A, TF_FUND_HIS B, TF_MEMBER C WHERE A.PIDX = B.PIDX AND B.IDX = C.IDX AND (A.STATUS = 1 AND A.IDX = 2) ORDER BY B.FIDX DESC;
SELECT B.*, C.* FROM TF_PROJECT_LIST A, TF_FUND_HIS B, TF_MEMBER C WHERE A.PIDX = B.PIDX AND B.IDX = C.IDX AND (A.STATUS = 1 AND A.IDX = ?) ORDER BY B.FIDX DESC;


-- cMemProjHisList 사업자 지난 프로젝트 리스트

SELECT * FROM TF_PROJECT_LIST WHERE STATUS > 3 AND IDX = ?;
SELECT * FROM TF_PROJECT_LIST WHERE STATUS > 3 AND IDX = 2;


-- cMemProjHisInfoGraph 사업자 지난 프로젝트 투자 인포 그래프

SELECT * FROM TF_PROJECT_LIST A, TF_FUND_HIS B WHERE A.PIDX = B.PIDX(+) AND A.STATUS > 3 AND A.IDX = ?;
SELECT * FROM TF_PROJECT_LIST A, TF_FUND_HIS B WHERE A.PIDX = B.PIDX(+) AND A.STATUS > 3 AND A.IDX = 2;


-- cMemNewsList 사업자 등록한 뉴스 리스트

SELECT * FROM TF_PROJECT_LIST A, TF_BOARD_NEWS B WHERE B.VIEWSTAT = 1 AND A.PIDX = B.EXTCOLUMN1 AND A.IDX = ?;
SELECT * FROM TF_PROJECT_LIST A, TF_BOARD_NEWS B WHERE B.VIEWSTAT = 1 AND A.PIDX = B.EXTCOLUMN1 AND A.IDX = 2;


-- cMemNewsWrite 사업자 뉴스 등록

INSERT INTO TF_BOARD_NEWS (BIDX, IDX, CATE, TITLE, CONTENTS, HIT, GOOD, BAD, OBIDX, RBIDX, BDEPTH, COMMCNT, VIEWSTAT, INSDATE, MODDATE, EXTCOLUMN1)
    VALUES (SEQ_TF_BIDX_NEWS.NEXTVAL, ?, (SELECT PCATE FROM TF_PROJECT_LIST WHERE PIDX = ?), ?, ?, 0, 0, 0, SEQ_TF_BIDX_NEWS.CURRVAL, 1, 1, 0, 1, SYSDATE, SYSDATE, ?);

INSERT INTO TF_BOARD_NEWS (BIDX, IDX, CATE, TITLE, CONTENTS, HIT, GOOD, BAD, OBIDX, RBIDX, BDEPTH, COMMCNT, VIEWSTAT, INSDATE, MODDATE, EXTCOLUMN1)
    VALUES (SEQ_TF_BIDX_NEWS.NEXTVAL, 2, (SELECT PCATE FROM TF_PROJECT_LIST WHERE PIDX = 1), '게시판입력 프로젝트 1 회원 2', '게시판 입력 내용 프로젝트 1 회원 2 내용', 0, 0, 0, SEQ_TF_BIDX_NEWS.CURRVAL, 1, 1, 0, 1, SYSDATE, SYSDATE, 1);


-- cMemNewsCon 사업자 뉴스 내용

SELECT * FROM TF_BOARD_NEWS A, TF_PROJECT_LIST B WHERE A.EXTCOLUMN1 = B.PIDX AND A.BIDX = ?;
SELECT * FROM TF_BOARD_NEWS A, TF_PROJECT_LIST B WHERE A.EXTCOLUMN1 = B.PIDX AND A.BIDX = 1;


-- cMemNewsMod 사업자 뉴스 수정 (제목, 내용,

UPDATE TF_BOARD_NEWS SET CATE = (SELECT PCATE FROM TF_PROJECT_LIST WHERE PIDX = ?), TITLE = ?, CONTENTS = ?, MODDATE = SYSDATE WHERE BIDX = ?;
UPDATE TF_BOARD_NEWS SET CATE = (SELECT PCATE FROM TF_PROJECT_LIST WHERE PIDX = 1), TITLE = '게시판 입력2 프로젝트 1 회원 2', CONTENTS = '게시판 입력2 내용2 프로젝트 1 회원 2 내용2', MODDATE = SYSDATE WHERE BIDX = 25;


-- cMemNewsDel 사업자 뉴스 삭제

UPDATE TF_BOARD_NEWS SET VIEWSTAT = 0, MODDATE = SYSDATE WHERE BIDX = ?;
UPDATE TF_BOARD_NEWS SET VIEWSTAT = 0, MODDATE = SYSDATE WHERE BIDX = 25;


-- cMemQnaList 사업자 qna 리스트 (사업자에게 질문한 qna)

SELECT * FROM TF_PROJECT_LIST A, TF_BOARD_QNA B WHERE A.PIDX = B.EXTCOLUMN1 AND A.IDX = ? ORDER BY B.OBIDX DESC, B.RBIDX ASC;
SELECT * FROM TF_PROJECT_LIST A, TF_BOARD_QNA B WHERE A.PIDX = B.EXTCOLUMN1 AND A.IDX = 2 ORDER BY B.OBIDX DESC, B.RBIDX ASC;

cMemQnaReplyWrite 사업자 qna 작성

INSERT INTO TF_BOARD_QNA (BIDX, IDX, CATE, TITLE, CONTENTS, HIT, GOOD, BAD, OBIDX, RBIDX, BDEPTH, COMMCNT, VIEWSTAT, INSDATE, MODDATE, EXTCOLUMN1)
    VALUES (SEQ_TF_BIDX_QNA.NEXTVAL, ?, (SELECT PCATE FROM TF_PROJECT_LIST WHERE PIDX = ?), ?, ?, 0, 0, 0, SEQ_TF_BIDX_QNA.CURRVAL, 1, 1, 0, 1, SYSDATE, SYSDATE, ?);

INSERT INTO TF_BOARD_QNA (BIDX, IDX, CATE, TITLE, CONTENTS, HIT, GOOD, BAD, OBIDX, RBIDX, BDEPTH, COMMCNT, VIEWSTAT, INSDATE, MODDATE, EXTCOLUMN1)
    VALUES (SEQ_TF_BIDX_QNA.NEXTVAL, 1, (SELECT PCATE FROM TF_PROJECT_LIST WHERE PIDX = 1), '프로젝트 1 관련 QNA 입력', '프로젝트 1 관련 QNA 입력', 0, 0, 0, SEQ_TF_BIDX_QNA.CURRVAL, 1, 1, 0, 1, SYSDATE, SYSDATE, 1);


-- cMemQnaReplyWrite 사업자 qna 답변 작성

UPDATE TF_BOARD_QNA SET RBIDX = RBIDX + 1 WHERE OBIDX = (SELECT OBIDX FROM TF_BOARD_QNA WHERE BIDX = ?) AND RBIDX > (SELECT RBIDX FROM TF_BOARD_QNA WHERE BIDX = ?);

INSERT INTO TF_BOARD_QNA (BIDX, IDX, CATE, TITLE, CONTENTS, HIT, GOOD, BAD, OBIDX, RBIDX, BDEPTH, COMMCNT, VIEWSTAT, INSDATE, MODDATE, EXTCOLUMN1)
    VALUES (SEQ_TF_BIDX_QNA.NEXTVAL, ?, (SELECT CATE FROM TF_BOARD_QNA WHERE BIDX = ?), ?, ?, 0, 0, 0, (SELECT OBIDX FROM TF_BOARD_QNA WHERE BIDX = ?), (SELECT RBIDX FROM TF_BOARD_QNA WHERE BIDX = ?) + 1, (SELECT BDEPTH FROM TF_BOARD_QNA WHERE BIDX = ?) + 1, 0, 1, SYSDATE, SYSDATE, (SELECT EXTCOLUMN1 FROM TF_BOARD_QNA WHERE BIDX = ?));

-- 원글 BIDX값을 가져와서 원글과 같은 ODBIDX 값을 갖으며 원글의 RBIDX 보다 큰 글들의 RBIDX 값을 + 1
UPDATE TF_BOARD_QNA SET RBIDX = RBIDX + 1 WHERE OBIDX = (SELECT OBIDX FROM TF_BOARD_QNA WHERE BIDX = 21) AND RBIDX > (SELECT RBIDX FROM TF_BOARD_QNA WHERE BIDX = 21);

INSERT INTO TF_BOARD_QNA (BIDX, IDX, CATE, TITLE, CONTENTS, HIT, GOOD, BAD, OBIDX, RBIDX, BDEPTH, COMMCNT, VIEWSTAT, INSDATE, MODDATE, EXTCOLUMN1)
    VALUES (SEQ_TF_BIDX_QNA.NEXTVAL, 2, (SELECT CATE FROM TF_BOARD_QNA WHERE BIDX = 21), '답변 프로젝트 1 관련 QNA 답변 입력', '프로젝트 1 관련 QNA 답변 입력', 0, 0, 0, (SELECT OBIDX FROM TF_BOARD_QNA WHERE BIDX = 21), (SELECT RBIDX FROM TF_BOARD_QNA WHERE BIDX = 21) + 1, (SELECT BDEPTH FROM TF_BOARD_QNA WHERE BIDX = 21) + 1, 0, 1, SYSDATE, SYSDATE, (SELECT EXTCOLUMN1 FROM TF_BOARD_QNA WHERE BIDX = 21));


--cMemQnaReplayMod 사업자 qna 답변 수정

UPDATE TF_BOARD_QNA SET TITLE = ?, CONTENTS = ?, MODDATE = SYSDATE WHERE BIDX = ?;
UPDATE TF_BOARD_QNA SET TITLE = '답변 프로젝트 1 관련 QNA 수정', CONTENTS = '답변 프로젝트 1 관련 QNA 수정', MODDATE = SYSDATE WHERE BIDX = 22;


-- boardNewsList 메인페이지 뉴스 리스트
-- boardNewsListCate 메인페이지 카테고리별 뉴스 리스트
-- 게시판 리스트 출력 (답글 출력으로 인한 ORDER BY, 출력유무 VIEWSTAT 체크)

SELECT * FROM TF_BOARD_NEWS WHERE VIEWSTAT = 1 AND CATE = ? ORDER BY OBIDX DESC, RBIDX ASC;
SELECT * FROM TF_BOARD_NEWS WHERE VIEWSTAT = 1 AND CATE = 'TECH' ORDER BY OBIDX DESC, RBIDX ASC;


-- boardNewsCon 메인페이지 뉴스 상세내용

SELECT * FROM TF_BOARD_NEWS WHERE BIDX = ?;
SELECT * FROM TF_BOARD_NEWS WHERE BIDX = 1;


-- boardNewsCommList 메인페이지 뉴스 댓글 리스트

SELECT * FROM TF_BOARD_COMM_NEWS WHERE BIDX = ? AND VIEWSTAT = 1 ORDER BY OCOMMIDX DESC, RCOMMIDX ASC;
SELECT * FROM TF_BOARD_COMM_NEWS WHERE BIDX = 1 AND VIEWSTAT = 1 ORDER BY OCOMMIDX DESC, RCOMMIDX ASC;


-- boardNewsCommWrite 메인페이지 뉴스 댓글 작성

INSERT INTO TF_BOARD_COMM_NEWS (COMMIDX, BIDX, IDX, COMMENTS, GOOD, BAD, OCOMMIDX, RCOMMIDX, COMMDEPTH, VIEWSTAT, INSDATE, MODDATE)
  VALUES (SEQ_TF_COMMIDX_NEWS.NEXTVAL, ?, ?, ?, 0, 0, SEQ_TF_COMMIDX_NEWS.CURRVAL, 1, 1, 1, SYSDATE, SYSDATE);
INSERT INTO TF_BOARD_COMM_NEWS (COMMIDX, BIDX, IDX, COMMENTS, GOOD, BAD, OCOMMIDX, RCOMMIDX, COMMDEPTH, VIEWSTAT, INSDATE, MODDATE)
  VALUES (SEQ_TF_COMMIDX_NEWS.NEXTVAL, 1, 2, 'BIDX 1 IDX 2 뉴스 댓글 DEPTH 1', 0, 0, SEQ_TF_COMMIDX_NEWS.CURRVAL, 1, 1, 1, SYSDATE, SYSDATE);


-- boardNewsSubCommWrite 메인페이지 뉴스 대댓글 작성

UPDATE TF_BOARD_COMM_NEWS SET RCOMMIDX = RCOMMIDX + 1 WHERE OCOMMIDX = (SELECT OCOMMIDX FROM TF_BOARD_COMM_NEWS WHERE COMMIDX = ?) AND RCOMMIDX > (SELECT RCOMMIDX FROM TF_BOARD_COMM_NEWS WHERE COMMIDX = ?);

INSERT INTO TF_BOARD_COMM_NEWS (COMMIDX, BIDX, IDX, COMMENTS, GOOD, BAD, OCOMMIDX, RCOMMIDX, COMMDEPTH, VIEWSTAT, INSDATE, MODDATE)
  VALUES (SEQ_TF_COMMIDX_NEWS.NEXTVAL, (SELECT BIDX FROM TF_BOARD_COMM_NEWS WHERE COMMIDX = ?), ?, ?, 0, 0, (SELECT OCOMMIDX FROM TF_BOARD_COMM_NEWS WHERE COMMIDX = ?), (SELECT RCOMMIDX FROM TF_BOARD_COMM_NEWS WHERE COMMIDX = ?) + 1, (SELECT COMMDEPTH FROM TF_BOARD_COMM_NEWS WHERE COMMIDX = ?) + 1, 1, SYSDATE, SYSDATE);

UPDATE TF_BOARD_COMM_NEWS SET RCOMMIDX = RCOMMIDX + 1 WHERE OCOMMIDX = (SELECT OCOMMIDX FROM TF_BOARD_COMM_NEWS WHERE COMMIDX = 1) AND RCOMMIDX > (SELECT RCOMMIDX FROM TF_BOARD_COMM_NEWS WHERE COMMIDX = 1);
INSERT INTO TF_BOARD_COMM_NEWS (COMMIDX, BIDX, IDX, COMMENTS, GOOD, BAD, OCOMMIDX, RCOMMIDX, COMMDEPTH, VIEWSTAT, INSDATE, MODDATE)
  VALUES (SEQ_TF_COMMIDX_NEWS.NEXTVAL, (SELECT BIDX FROM TF_BOARD_COMM_NEWS WHERE COMMIDX = 1), 4, 'BIDX 1 IDX 2 뉴스 대댓글 DEPTH 2', 0, 0, (SELECT OCOMMIDX FROM TF_BOARD_COMM_NEWS WHERE COMMIDX = 1), (SELECT RCOMMIDX FROM TF_BOARD_COMM_NEWS WHERE COMMIDX = 1) + 1, (SELECT COMMDEPTH FROM TF_BOARD_COMM_NEWS WHERE COMMIDX = 1) + 1, 1, SYSDATE, SYSDATE);


-- boardNewsCommWrite CntMod 메인페이지 뉴스 댓글 작성 수정 **추가
-- boardNewsProjList 메인페이지 뉴스 연동 프로젝트 리스트
-- boardNewsHit 메인페이지 뉴스 조회수 증가